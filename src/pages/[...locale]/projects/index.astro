---
import WebLayout from "../_components/layouts/web-layout/index.astro";
import { getLangFromUrl, useTranslations } from "../../../i18n";
import type { WebProjectsResponseDto } from "@modules/web/dtos/web.response.dto";
import SsrPagination from "@components/extras/ssr-pagination.astro";
import { ExternalLink, GitBranch, Star } from "lucide-preact";
import { printFileWithDimension } from "@infrastructure/utils/hybrid/file.utils";
import { DIMENSION_IMAGE } from "@modules/uploads/const/upload.const";
import { STORAGE_CDN_URL } from "astro:env/server";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const { projects, title, page, limit, total } = Astro.locals
  .props as WebProjectsResponseDto;

// Status colors
const statusColors = {
  live: "bg-green-500/20 text-green-400 border-green-500/30",
  in_dev: "bg-yellow-500/20 text-yellow-400 border-yellow-500/30",
  archived: "bg-zinc-500/20 text-zinc-400 border-zinc-500/30",
} as const;

const statusLabels = {
  live: t("projects.status.live"),
  in_dev: t("projects.status.in_dev"),
  archived: t("projects.status.archived"),
} as const;
---

<WebLayout title={title}>
  <div class="container mx-auto py-20 px-4 min-h-screen">
    <div class="flex flex-col items-center text-center mb-16 space-y-4">
      <span class="text-primary font-mono text-sm tracking-widest uppercase">
        {t("projects.my_work")}
      </span>
      <h1
        class="text-5xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-b from-white to-white/40"
      >
        {t("projects.title")}
      </h1>
      <p class="text-xl text-muted-foreground max-w-2xl font-light">
        {t("projects.description")}
      </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      {
        projects.map((project, index) => (
          <a
            href={`/${lang}/projects/${project.slug}`}
            class={`group relative block rounded-2xl overflow-hidden bg-card border border-white/5 transition-all duration-500 hover:border-primary/50 hover:shadow-2xl hover:shadow-primary/10 ${index === 0 ? "lg:col-span-2" : ""}`}
          >
            {/* Image */}
              <div
              class={`relative overflow-hidden ${index === 0 ? "aspect-[21/9]" : "aspect-video"}`}
            >
              {project.images ? (
                <img
                  src={
                    printFileWithDimension(
                      project.images,
                      DIMENSION_IMAGE.lg,
                      STORAGE_CDN_URL
                    )[0]
                  }
                  alt={project.title}
                  class="w-full h-full object-cover transition-transform duration-1000 group-hover:scale-105"
                />
              ) : (
                <div class="w-full h-full bg-gradient-to-br from-primary/20 to-primary/5 flex items-center justify-center">
                  <span class="text-6xl font-black text-primary/30">
                    {project.title.charAt(0)}
                  </span>
                </div>
              )}

              <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent" />
            </div>

            {/* Content */}
            <div class="absolute bottom-0 left-0 right-0 p-6 md:p-8">
              {/* Status + Year */}
              <div class="flex items-center gap-3 mb-4">
                <span
                  class={`text-xs font-bold px-3 py-1 rounded-full border ${statusColors[project.status]}`}
                >
                  {statusLabels[project.status]}
                </span>
                {project.is_featured && (
                  <span class="flex items-center gap-1 text-yellow-400 text-xs font-mono">
                    <Star size={12} />
                    Featured
                  </span>
                )}
                <span class="text-white/40 text-xs font-mono ml-auto">
                  {project.start_date
                    ? new Date(project.start_date).getFullYear()
                    : ""}
                </span>
              </div>

              {/* Title */}
              <h2 class="text-2xl md:text-3xl font-bold text-white mb-2 group-hover:text-primary transition-colors">
                {project.title}
              </h2>

              {/* Description */}
              <p class="text-white/70 line-clamp-2 mb-4 text-sm md:text-base">
                {project.description}
              </p>

              {/* Technologies */}
              {project.techeables && project.techeables.length > 0 && (
                <div class="flex flex-wrap gap-2 mb-4">
                  {project.techeables.slice(0, 5).map((techeable) => (
                    <span class="flex items-center gap-1.5 text-xs font-mono bg-white/5 text-white/70 px-2 py-1 rounded-md border border-white/10">
                      {techeable.technology.icon?.[0] && (
                        <img
                          src={printFileWithDimension(
                            techeable.technology.icon,
                             DIMENSION_IMAGE.xs,
                             STORAGE_CDN_URL  
                          )[0]}
                          alt={techeable.technology.name}
                          class="w-3 h-3 object-contain"
                        />
                      )}
                      {techeable.technology.name}
                    </span>
                  ))}
                  {project.techeables.length > 5 && (
                    <span class="text-xs font-mono text-white/40 px-2 py-1">
                      +{project.techeables.length - 5} more
                    </span>
                  )}
                </div>
              )}

              {/* Links */}
              <div class="flex items-center gap-4 pt-2 border-t border-white/10">
                {project.website_url && (
                  <span class="flex items-center gap-1 text-white/50 text-xs font-mono">
                    <ExternalLink size={12} />
                    Demo
                  </span>
                )}
                {project.repo_url && (
                  <span class="flex items-center gap-1 text-white/50 text-xs font-mono">
                    <GitBranch size={12} />
                    {project.github_stars
                      ? `${project.github_stars} â˜…`
                      : "Code"}
                  </span>
                )}
              </div>
            </div>
          </a>
        ))
      }
      {
        projects.length === 0 && (
          <div class="col-span-full flex flex-col items-center justify-center py-32 text-center border border-dashed border-white/10 rounded-3xl">
            <div class="w-16 h-16 rounded-full bg-white/5 flex items-center justify-center mb-4 text-muted-foreground">
              <span class="text-2xl">?</span>
            </div>
            <p class="text-xl font-bold text-white">
              {t("projects.none")}
            </p>
            <p class="text-muted-foreground">
              {t("projects.check_back")}
            </p>
          </div>
        )
      }
    </div>

    <SsrPagination
      page={page}
      limit={limit}
      total={total}
      baseUrl={`/${lang}/projects`}
    />
  </div>
</WebLayout>
