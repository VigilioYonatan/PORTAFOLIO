---
import WebLayout from "../_components/layouts/web-layout/index.astro";
import FuturisticMDX from "@modules/blog-post/components/futuristic-mdx";
import SocialHub from "@modules/blog-post/components/social-hub";
import { ProjectGallery } from "@modules/project/components/project-gallery";
import { Globe, Calendar, ArrowLeft } from "@lucide/astro";
import { printFileWithDimension } from "@infrastructure/utils/hybrid/file.utils";
import { DIMENSION_IMAGE } from "@modules/uploads/const/upload.const";
import { STORAGE_URL } from "astro:env/server";
import { BrandIcon } from "@components/extras/brand-icon";
import { siGithub } from "simple-icons";
import { getLangFromUrl, useTranslations } from "../../../i18n";
import { renderMarkdown } from "@infrastructure/utils/server";
import type { WebProjectSlugResponseDto } from "@modules/web/dtos/web.response.dto";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const { project } = Astro.locals.props as WebProjectSlugResponseDto;

if (!project) {
  return Astro.redirect("/404");
}

const htmlContent = await renderMarkdown(project.content);

// Status styling
const statusColors = {
  live: "bg-green-500/20 text-green-400 border-green-500/30",
  in_dev: "bg-yellow-500/20 text-yellow-400 border-yellow-500/30",
  archived: "bg-zinc-500/20 text-zinc-400 border-zinc-500/30",
} as const;

const statusLabels = {
  live: t("projects.status.live"),
  in_dev: t("projects.status.in_dev"),
  archived: t("projects.status.archived"),
} as const;

const allImages = project.images || [];

const title = `${project.title} | ${t("header.projects")}`;
const description = project.description;
---

<WebLayout
  title={title}
  description={description}
  translations={(Astro.locals.props as WebProjectSlugResponseDto).translations}
>
  <div class="min-h-screen">
    {/* Hero Header with Image */}
    <div class="relative min-h-[50vh] flex items-end overflow-hidden">
      {/* Background Image */}
      {
        project.images ? (
          <img
            src={
              printFileWithDimension(
                project.images,
                DIMENSION_IMAGE.lg,
                STORAGE_URL
              )[0]
            }
            alt={project.title}
            class="absolute inset-0 w-full h-full object-cover"
          />
        ) : (
          <div class="absolute inset-0 bg-linear-to-br from-primary/20 to-background" />
        )
      }

      {/* Gradient Overlay */}
      <div
        class="absolute inset-0 bg-linear-to-t from-background via-background/80 to-transparent"
      >
      </div>

      {/* Content */}
      <div class="container mx-auto px-4 relative z-10 pb-12 pt-24">
        {/* Back Link */}
        <a
          href={`/${lang}/projects`}
          class="inline-flex items-center gap-2 text-sm text-muted-foreground hover:text-white transition-colors mb-8"
        >
          <ArrowLeft size={16} />
          {t("slug.back_to_archives")}
        </a>

        {/* Status Badge */}
        <div class="flex items-center gap-4 mb-4">
          <span
            class={`text-xs font-bold px-3 py-1 rounded-full border ${statusColors[project.status]}`}
          >
            {statusLabels[project.status]}
          </span>
          {
            project.start_date && (
              <span class="flex items-center gap-1 text-muted-foreground text-sm">
                <Calendar size={14} />
                {new Date(project.start_date).getFullYear()}
                {project.end_date &&
                  ` - ${new Date(project.end_date).getFullYear()}`}
              </span>
            )
          }
        </div>

        {/* Title */}
        <h1 class="text-4xl md:text-6xl font-black mb-4 text-white">
          {project.title}
        </h1>

        {/* Description */}
        <p class="text-xl text-muted-foreground max-w-3xl mb-8">
          {project.description}
        </p>

        {/* Action Buttons */}
        <div class="flex flex-wrap gap-4">
          {
            project.website_url && (
              <a
                href={project.website_url}
                target="_blank"
                rel="noopener noreferrer"
                class="flex items-center gap-2 px-6 py-3 bg-primary text-black font-bold text-sm rounded-lg hover:bg-primary/90 transition-colors"
              >
                <Globe size={18} />
                {t("slug.live_demo")}
              </a>
            )
          }
          {
            project.repo_url && (
              <a
                href={project.repo_url}
                target="_blank"
                rel="noopener noreferrer"
                class="flex items-center gap-2 px-6 py-3 border border-white/20 text-white font-bold text-sm rounded-lg hover:bg-white/10 transition-colors"
              >
                <BrandIcon icon={siGithub} size={18} />
                {t("slug.source_code")}
                {project.github_stars && (
                  <span class="text-yellow-400 ml-1">
                    â˜… {project.github_stars}
                  </span>
                )}
              </a>
            )
          }
        </div>
      </div>
    </div>

    <div class="container mx-auto py-12 px-4 max-w-7xl">

      <div class="flex flex-col lg:flex-row gap-8">
        {/* Left Sidebar - Tech Stack & Stats */}
        <aside class="lg:w-64 flex-shrink-0 order-2 lg:order-1">
          <div class="lg:sticky lg:top-24 space-y-6">
            {/* Tech Stack */}
            {
              project.techeables && project.techeables.length > 0 && (
                <div class="p-5 border border-white/10 rounded-2xl bg-card/50 backdrop-blur-sm">
                  <h4 class="font-bold mb-4 font-mono text-xs uppercase tracking-widest text-primary">
                    {t("slug.tech_stack")}
                  </h4>
                  <div class="space-y-2">
                    {project.techeables.map((techeable) => (
                      <div class="flex items-center gap-3 p-2.5 rounded-lg bg-white/5 hover:bg-white/10 transition-colors">
                        {techeable.technology.icon?.[0] ? (
                          <img
                            src={
                              printFileWithDimension(
                                techeable.technology.icon,
                                DIMENSION_IMAGE.xs,
                                STORAGE_URL
                              )[0]
                            }
                            alt={techeable.technology.name}
                            class="w-5 h-5 object-contain"
                          />
                        ) : (
                          <div class="w-5 h-5 rounded bg-primary/20 flex items-center justify-center text-[10px] text-primary font-bold">
                            {techeable.technology.name.charAt(0)}
                          </div>
                        )}
                        <span class="text-sm font-medium text-white flex-1">
                          {techeable.technology.name}
                        </span>
                      </div>
                    ))}
                  </div>
                </div>
              )
            }

            {/* Languages Stats */}
            {
              project.languages_stats && project.languages_stats.length > 0 ? (
                <div class="p-5 border border-white/10 rounded-2xl bg-card/50 backdrop-blur-sm">
                  <h4 class="font-bold mb-4 font-mono text-xs uppercase tracking-widest text-primary">
                    {t("dashboard.sidebar.technologies")}
                  </h4>
                  <div class="space-y-2.5">
                    {project.languages_stats.map((langStat) => (
                      <div class="space-y-1">
                        <div class="flex justify-between text-xs">
                          <span class="text-white font-medium">
                            {langStat.name}
                          </span>
                          <span class="text-muted-foreground">
                            {langStat.percent.toFixed(1)}%
                          </span>
                        </div>
                        <div class="h-1 bg-white/10 rounded-full overflow-hidden">
                          <div
                            class="h-full bg-gradient-to-r from-primary to-primary/60 rounded-full"
                            style={`width: ${langStat.percent}%`}
                          />
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              ):null
            }

            {/* GitHub Stats */}
            {
              (project.github_stars || project.github_forks) ? (
                <div class="p-5 border border-white/10 rounded-2xl bg-card/50 backdrop-blur-sm">
                  <h4 class="font-bold mb-4 font-mono text-xs uppercase tracking-widest text-primary">
                    GitHub
                  </h4>
                  <div class="grid grid-cols-2 gap-3">
                    {project.github_stars !== null && (
                      <div class="text-center p-3 rounded-xl bg-white/5">
                        <div class="text-xl font-bold text-white">
                          {project.github_stars}
                        </div>
                        <div class="text-[10px] text-muted-foreground uppercase tracking-wider">
                          Stars
                        </div>
                      </div>
                    )}
                    {project.github_forks !== null && (
                      <div class="text-center p-3 rounded-xl bg-white/5">
                        <div class="text-xl font-bold text-white">
                          {project.github_forks}
                        </div>
                        <div class="text-[10px] text-muted-foreground uppercase tracking-wider">
                          Forks
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              ):null
            }
          </div>
        </aside>

        {/* Main Content */}
        <main class="flex-1 order-1 lg:order-2 min-w-0">
          <div class="space-y-10">
            {/* Impact Summary */}
            {
              project.impact_summary && (
                <div class="p-6 rounded-2xl bg-gradient-to-br from-primary/10 to-purple-500/5 border border-primary/20 relative overflow-hidden">
                  <div class="absolute top-0 right-0 w-32 h-32 bg-primary/10 rounded-full blur-3xl" />
                  <h3 class="font-mono text-primary mb-2 text-sm uppercase tracking-wider relative z-10">
                    {t("slug.impact_summary")}
                  </h3>
                  <p class="text-xl text-white font-medium relative z-10">
                    {project.impact_summary}
                  </p>
                </div>
              )
            }

            {/* Markdown Content */}
            <FuturisticMDX
              client:load
              content={project.content}
              renderedHtml={htmlContent}
            />

            {/* Social Hub */}
            <SocialHub
              lang={lang}
              client:only="preact"
              likes={0}
              comments={0}
              id={project.id}
              entityType="PORTFOLIO_PROJECT"
            />
          </div>
        </main>

        {/* Right Sidebar - Image Gallery */}
        {
          allImages.length > 0 ? (
            <aside class="lg:w-72 xl:w-80 flex-shrink-0 order-3">
              <div class="lg:sticky lg:top-24">
                <ProjectGallery
                  client:only="preact"
                  images={allImages}
                  projectTitle={project.title}
                  lang={lang}
                />
              </div>
            </aside>
          ) : (
            null  
          )
        }
      </div>
    </div>
  </div>
</WebLayout>

<style>
  @keyframes fade-in {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }
  @keyframes zoom-in {
    from {
      transform: scale(0.95);
      opacity: 0;
    }
    to {
      transform: scale(1);
      opacity: 1;
    }
  }
  :global(.animate-fade-in) {
    animation: fade-in 0.2s ease-out;
  }
  :global(.animate-zoom-in) {
    animation: zoom-in 0.2s ease-out;
  }

  /* Custom video controls styling */
  video::-webkit-media-controls-panel {
    background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
  }
</style>
