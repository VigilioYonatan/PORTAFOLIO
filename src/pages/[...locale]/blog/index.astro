---
import WebLayout from "../_components/layouts/web-layout/index.astro";
import { getLangFromUrl, useTranslations } from "../../../i18n";
import type { WebBlogResponseDto } from "../../../modules/web/dtos/web.response.dto";
import SsrPagination from "@components/extras/ssr-pagination.astro";
import { ArrowRight } from "lucide-preact";
import { printFileWithDimension } from "@infrastructure/utils/hybrid/file.utils";
import { DIMENSION_IMAGE } from "@modules/uploads/const/upload.const";
import { STORAGE_CDN_URL } from "astro:env/server";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const { posts, title, page, limit, total } = Astro.locals
  .props as WebBlogResponseDto;
---

<WebLayout title={title}>
  <div class="container mx-auto py-20 px-4 min-h-screen">
    <div class="flex flex-col items-center text-center mb-16 space-y-4">
      <h1
        class="text-5xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-b from-white to-white/40"
      >
        {t("blog.title")}
      </h1>
      <p class="text-xl text-muted-foreground max-w-2xl font-light">
        {
          lang === "es"
            ? "Explorando ideas en la frontera de la tecnolog√≠a."
            : "Exploring ideas at the frontier of technology."
        }
      </p>
    </div>

    {
      posts.length > 0 && page === 1 && (
        <a
          href={`/${lang}/blog/${posts[0].slug}`}
          class="group relative block w-full aspect-[2/1] md:aspect-[21/9] rounded-3xl overflow-hidden mb-16 border border-white/10 hover:border-primary/50 transition-all duration-500 shadow-2xl"
        >
          {posts[0].cover?.[0] && (
            <img
              src={
                printFileWithDimension(
                  posts[0].cover,
                  DIMENSION_IMAGE.lg,
                  STORAGE_CDN_URL,
                )[0]
              }
              alt={posts[0].title}
              class="w-full h-full object-cover transition-transform duration-1000 group-hover:scale-105"
            />
          )}
          <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent" />
          <div class="absolute bottom-0 left-0 p-8 md:p-12 w-full md:w-2/3">
            <div class="flex items-center gap-2 mb-4">
              <span class="bg-primary text-black text-xs font-bold px-3 py-1 rounded-full uppercase tracking-widest">
                Featured
              </span>
              <span class="text-white/60 text-xs font-mono">
                {posts[0].published_at
                  ? new Date(posts[0].published_at).toLocaleDateString()
                  : ""}
              </span>
            </div>
            <h2 class="text-3xl md:text-5xl font-black text-white mb-4 leading-tight group-hover:text-primary transition-colors">
              {posts[0].title}
            </h2>
            <p class="text-lg text-white/80 line-clamp-2 md:line-clamp-3">
              {posts[0].extract}
            </p>
          </div>
        </a>
      )
    }

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
      {
        (page === 1 ? posts.slice(1) : posts).map((post) => (
          <a
            href={`/${lang}/blog/${post.slug}`}
            class="group flex flex-col bg-card border border-white/5 rounded-2xl overflow-hidden hover:bg-white/[0.02] hover:border-primary/20 transition-all duration-300 hover:-translate-y-1"
          >
            <div class="aspect-[16/10] bg-muted overflow-hidden relative">
              {post.cover && post.cover.length > 0 ? (
                <img
                  src={
                    printFileWithDimension(
                      post.cover,
                      DIMENSION_IMAGE.md,
                      STORAGE_CDN_URL,
                    )[0]
                  }
                  alt={post.title}
                  class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
                />
              ) : null}
            </div>

            <div class="p-6 flex flex-col flex-1 gap-4">
              <div class="flex items-center justify-between text-xs font-mono text-muted-foreground/60">
                <span>
                  {post.published_at
                    ? new Date(post.published_at).toLocaleDateString()
                    : ""}
                </span>
                <span class="uppercase text-primary/80">{post.language}</span>
              </div>
              <h2 class="text-xl font-bold leading-tight group-hover:text-primary transition-colors">
                {post.title}
              </h2>
              <p class="text-sm text-muted-foreground line-clamp-3 flex-1 leading-relaxed">
                {post.extract}
              </p>
              <div class="flex items-center gap-2 text-primary font-mono text-xs mt-auto opacity-0 group-hover:opacity-100 transition-opacity transform translate-x-[-10px] group-hover:translate-x-0 duration-300">
                Read Article <ArrowRight size={12} />
              </div>
            </div>
          </a>
        ))
      }
      {
        posts.length === 0 && (
          <div class="col-span-full py-20 text-center text-muted-foreground italic border border-dashed border-white/10 rounded-2xl">
            No posts found.
          </div>
        )
      }
    </div>

    <SsrPagination
      page={page}
      limit={limit}
      total={total}
      baseUrl={`/${lang}/blog`}
    />
  </div>
</WebLayout>
